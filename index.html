<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Workout">
    <meta name="theme-color" content="#ffffff">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23ffffff' width='100' height='100'/><text y='75' font-size='70' text-anchor='middle' x='50'>üí™</text></svg>">
    <link rel="manifest" href="manifest.json">
    <title>Workout Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #007AFF;
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
            --purple: #AF52DE;
            --teal: #5AC8FA;
            --bg: #ffffff;
            --bg-secondary: #F2F2F7;
            --text: #000000;
            --text-secondary: #6C6C70;
            --border: #E5E5EA;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom);
            overflow-x: hidden;
        }

        /* Loading Splash Screen */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeOut 0.5s ease-out 1.5s forwards;
        }

        .splash-logo {
            font-size: 80px;
            animation: scaleIn 0.6s ease-out;
        }

        .splash-text {
            margin-top: 20px;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
            animation: fadeIn 0.6s ease-out 0.3s backwards;
        }

        @keyframes scaleIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; pointer-events: none; }
        }

        /* Main Container */
        .app-container {
            max-width: 428px;
            margin: 0 auto;
            background: var(--bg);
            min-height: 100vh;
            position: relative;
            padding-bottom: 90px;
        }

        /* Top Bar */
        .top-bar {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.9);
            border-bottom: 1px solid var(--border);
            padding: 16px 20px;
            z-index: 100;
            backdrop-filter: blur(20px);
        }

        .top-bar-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 17px;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 0;
        }

        .page-title {
            font-size: 17px;
            font-weight: 600;
            letter-spacing: -0.4px;
        }

        .top-action {
            color: var(--primary);
            font-size: 17px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }
        
        .edit-mode .input-field {
            background: white;
            border: 2px solid var(--primary);
        }
        
        .delete-photo-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255, 59, 48, 0.95);
            border: none;
            color: white;
            font-size: 18px;
            line-height: 1;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }
        
        .thumbnail-wrapper {
            position: relative;
        }
        
        .thumbnail-wrapper:hover .delete-photo-btn {
            display: flex;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
            z-index: 100;
            max-width: 428px;
            margin: 0 auto;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 6px 20px;
            border: none;
            background: none;
            color: var(--text-secondary);
            font-size: 10px;
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            font-size: 24px;
        }

        /* Pages */
        .page {
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .page.active {
            display: block;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Home Page */
        .home-header {
            padding: 24px 20px 16px;
        }

        .greeting {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.8px;
            margin-bottom: 4px;
        }

        .date-text {
            color: var(--text-secondary);
            font-size: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 0 20px 20px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
        }

        .stat-card.large {
            grid-column: span 2;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -1px;
            line-height: 1;
        }

        .stat-change {
            font-size: 13px;
            margin-top: 6px;
            font-weight: 600;
            color: var(--success);
        }

        .quick-actions {
            padding: 0 20px 24px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 16px;
        }

        .action-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .action-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border: none;
            width: 100%;
            text-align: left;
        }

        .action-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .action-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .action-icon.sun { background: rgba(255, 149, 0, 0.15); }
        .action-icon.tue { background: rgba(52, 199, 89, 0.15); }
        .action-icon.fri { background: rgba(0, 122, 255, 0.15); }

        .action-text h3 {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .action-text p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .action-arrow {
            font-size: 20px;
            color: var(--text-secondary);
        }

        /* Exercise Page */
        .progress-section {
            padding: 16px 20px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 13px;
            color: var(--text-secondary);
            text-align: center;
            font-weight: 500;
        }

        .exercise-container {
            padding: 20px;
            padding-bottom: 100px;
        }

        .exercise-title {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.8px;
            margin-bottom: 8px;
        }

        .exercise-muscles {
            color: var(--text-secondary);
            font-size: 15px;
            margin-bottom: 16px;
        }

        .weight-section {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .weight-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .weight-row-2 {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 12px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .input-field {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            font-size: 17px;
            font-weight: 600;
            color: var(--text);
            width: 100%;
            max-width: 100%;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
        }

        .unit-selector {
            display: flex;
            background: var(--bg);
            border-radius: 12px;
            overflow: hidden;
        }

        .unit-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .unit-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Image Gallery */
        .image-gallery-section {
            background: var(--bg-secondary);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .gallery-main {
            position: relative;
            width: 100%;
            aspect-ratio: 4/3;
            background: #f9f9f9;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gallery-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }

        .gallery-image.active {
            display: block;
        }

        .gallery-placeholder {
            text-align: center;
            padding: 40px 20px;
        }

        .placeholder-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.3;
        }

        .upload-btn-text {
            color: var(--primary);
            font-size: 17px;
            font-weight: 600;
        }

        .gallery-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .gallery-nav.left { left: 12px; }
        .gallery-nav.right { right: 12px; }
        
        .gallery-nav:disabled {
            opacity: 0.3;
        }

        .gallery-thumbnails {
            display: flex;
            gap: 8px;
            padding: 12px;
            overflow-x: auto;
        }

        .thumbnail {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid transparent;
            flex-shrink: 0;
        }

        .thumbnail.active {
            border-color: var(--primary);
        }

        .thumbnail-add {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: var(--bg);
            border: 2px dashed var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            flex-shrink: 0;
        }

        /* Expandable Sections */
        .expandable-section {
            background: var(--bg-secondary);
            border-radius: 16px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .expandable-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 20px;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .expandable-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--text);
        }

        .expand-icon {
            color: var(--text-secondary);
            transition: transform 0.3s;
        }

        .expandable-section.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .expandable-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .expandable-section.expanded .expandable-content {
            max-height: 1000px;
        }

        .expandable-inner {
            padding: 0 20px 20px;
        }

        .steps-list {
            list-style: none;
        }

        .step-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            font-size: 15px;
            line-height: 1.5;
        }

        .step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .tips-grid {
            display: grid;
            gap: 8px;
        }

        .tip-item {
            padding: 12px;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.4;
        }

        .tip-focus {
            background: rgba(52, 199, 89, 0.1);
            border-left: 3px solid var(--success);
        }

        .tip-avoid {
            background: rgba(255, 59, 48, 0.1);
            border-left: 3px solid var(--danger);
        }

        /* Navigation Buttons */
        .nav-buttons {
            position: fixed;
            bottom: calc(70px + env(safe-area-inset-bottom));
            left: 0;
            right: 0;
            padding: 12px 20px;
            background: linear-gradient(to top, var(--bg) 50%, transparent);
            display: flex;
            gap: 12px;
            max-width: 428px;
            margin: 0 auto;
        }

        .nav-btn {
            flex: 1;
            padding: 16px;
            border-radius: 12px;
            border: none;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
        }

        .nav-btn.secondary {
            background: var(--bg-secondary);
            color: var(--text);
        }

        .nav-btn.primary {
            background: var(--primary);
            color: white;
        }

        .nav-btn:disabled {
            opacity: 0.3;
        }

        /* Dashboard */
        .dashboard-container {
            padding: 20px;
        }

        .filter-row {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .filter-select {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg);
            font-size: 15px;
        }

        .chart-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chart-header {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .chart-container {
            height: 240px;
        }

        .records-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .record-item {
            display: flex;
            justify-content: space-between;
            padding: 16px;
            background: var(--bg);
            border-radius: 12px;
        }

        .record-info h4 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .record-date {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .record-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }

        .completion-screen {
            text-align: center;
            padding: 60px 40px;
        }

        .completion-icon {
            font-size: 80px;
            margin-bottom: 24px;
        }

        .completion-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .completion-text {
            font-size: 17px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .completion-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 60px 40px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div class="splash-screen">
        <div class="splash-logo">üí™</div>
        <div class="splash-text">Workout Tracker</div>
    </div>

    <div class="app-container">
        <!-- Home Page -->
        <div class="page active" id="homePage">
            <div class="home-header">
                <h1 class="greeting">Hello, Dion</h1>
                <p class="date-text" id="currentDate"></p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Streak</div>
                    <div class="stat-value" id="homeStreak">0</div>
                    <div class="stat-change" id="homeStreakChange">days</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">This Week</div>
                    <div class="stat-value" id="homeWeekly">0</div>
                    <div class="stat-change">workouts</div>
                </div>
                <div class="stat-card large">
                    <div class="stat-label">Total Workouts</div>
                    <div class="stat-value" id="homeTotal">0</div>
                    <div class="stat-change" id="homeTotalChange">+0 this month</div>
                </div>
            </div>

            <div class="quick-actions">
                <h2 class="section-title">This Week's Workouts</h2>
                <div class="action-cards">
                    <button class="action-card" onclick="startWorkout('posterior')">
                        <div class="action-info">
                            <div class="action-icon sun">üî•</div>
                            <div class="action-text">
                                <h3>Posterior Day</h3>
                                <p>Sunday ‚Ä¢ Back & Glutes</p>
                            </div>
                        </div>
                        <span class="action-arrow">‚Ä∫</span>
                    </button>
                    <button class="action-card" onclick="startWorkout('fullbody')">
                        <div class="action-info">
                            <div class="action-icon tue">üíö</div>
                            <div class="action-text">
                                <h3>Full Body Day</h3>
                                <p>Tuesday ‚Ä¢ Total Body</p>
                            </div>
                        </div>
                        <span class="action-arrow">‚Ä∫</span>
                    </button>
                    <button class="action-card" onclick="startWorkout('anterior')">
                        <div class="action-info">
                            <div class="action-icon fri">‚ö°</div>
                            <div class="action-text">
                                <h3>Anterior Day</h3>
                                <p>Friday ‚Ä¢ Chest & Arms</p>
                            </div>
                        </div>
                        <span class="action-arrow">‚Ä∫</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Exercise Page -->
        <div class="page" id="exercisePage">
            <div class="top-bar">
                <div class="top-bar-content">
                    <button class="back-btn" onclick="exitWorkout()">‚Äπ Back</button>
                    <span class="page-title" id="workoutName"></span>
                    <button class="top-action" id="editBtn" onclick="toggleEdit()">Edit</button>
                </div>
            </div>

            <div class="progress-section">
                <div class="progress-bar">
                    <div class="progress-fill" id="exerciseProgress"></div>
                </div>
                <div class="progress-text" id="exerciseProgressText"></div>
            </div>

            <div class="exercise-container" id="exerciseContent"></div>

            <div class="nav-buttons">
                <button class="nav-btn secondary" id="prevExercise" onclick="previousExercise()">Previous</button>
                <button class="nav-btn primary" id="nextExercise" onclick="nextExercise()">Next</button>
            </div>
        </div>

        <!-- Stats Page -->
        <div class="page" id="statsPage">
            <div class="top-bar">
                <div class="top-bar-content">
                    <span></span>
                    <span class="page-title">Progress</span>
                    <span></span>
                </div>
            </div>

            <div class="dashboard-container">
                <div class="filter-row">
                    <select class="filter-select" id="exerciseFilter" onchange="updateDashboard()">
                        <option value="">All Exercises</option>
                    </select>
                    <select class="filter-select" id="timeframeFilter" onchange="updateDashboard()">
                        <option value="7">7 Days</option>
                        <option value="30" selected>30 Days</option>
                        <option value="90">90 Days</option>
                        <option value="all">All Time</option>
                    </select>
                </div>

                <div class="chart-card">
                    <h3 class="chart-header">Weight Progression</h3>
                    <div class="chart-container">
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3 class="chart-header">Personal Records</h3>
                    <div class="records-list" id="recordsList">
                        <div class="empty-state">
                            <div class="empty-icon">üèÜ</div>
                            <div>Complete workouts to see your PRs</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Nav -->
        <div class="bottom-nav">
            <button class="nav-item active" onclick="showPage('home')">
                <div class="nav-icon">üè†</div>
                <div>Home</div>
            </button>
            <button class="nav-item" onclick="showPage('stats')">
                <div class="nav-icon">üìä</div>
                <div>Progress</div>
            </button>
        </div>
    </div>

<script>
// Condensed workout data
const workouts = {
    posterior: { name: "Posterior Day", exercises: [
        { name: "Pull-Ups", muscles: "Back, Biceps, Rear Shoulders", goal: "Strengthen upper back", sets: "3 sets", reps: "6-12 reps", currentWeight: 0, weightUnit: "kg", steps: ["Hang from bar with hands shoulder-width", "Pull shoulder blades down and back", "Lower with control"], focus: ["Shoulder blades pull down first", "Chest to bar", "Full extension"], avoid: ["Swinging", "Shrugging", "Partial reps"] },
        { name: "Barbell Rows", muscles: "Upper Back, Lats", goal: "Build back thickness", sets: "3 sets", reps: "8-12 reps", currentWeight: 0, weightUnit: "kg", steps: ["Hinge at hips with flat back", "Pull weight to lower chest", "Squeeze shoulder blades"], focus: ["Flat back", "Lead with elbows", "Squeeze shoulder blades"], avoid: ["Rounding back", "Using momentum", "Shrugging"] },
        { name: "Rear Delt Fly", muscles: "Rear Shoulders", goal: "Balance shoulders", sets: "3 sets", reps: "12-15 reps", currentWeight: 0, weightUnit: "kg", steps: ["Hinge forward with dumbbells", "Raise arms out to sides", "Squeeze shoulder blades"], focus: ["Pull elbows back", "Slight bend in elbows", "Control movement"], avoid: ["Heavy weight", "Swinging", "Lifting torso"] },
        { name: "Romanian Deadlift", muscles: "Hamstrings, Glutes", goal: "Strengthen posterior chain", sets: "3 sets", reps: "8-12 reps", currentWeight: 0, weightUnit: "kg", steps: ["Stand with barbell", "Push hips back", "Drive hips forward"], focus: ["Hips move back", "Feel hamstring stretch", "Ribs down"], avoid: ["Rounding back", "Too much knee bend", "Overextending"] },
        { name: "Hip Thrust", muscles: "Glutes, Hamstrings", goal: "Strengthen glutes", sets: "3 sets", reps: "10-15 reps", currentWeight: 0, weightUnit: "kg", steps: ["Upper back on bench", "Drive through heels", "Straight line shoulders to knees"], focus: ["Glutes squeeze", "Straight body line", "Ribs down"], avoid: ["Arching back", "Pushing through toes", "Hyperextending"] },
        { name: "Bulgarian Split Squat", muscles: "Quads, Glutes", goal: "Single-leg strength", sets: "3 sets each", reps: "8-12 reps", currentWeight: 0, weightUnit: "kg", steps: ["Rear foot elevated", "Lower back knee down", "Drive through front heel"], focus: ["Torso stays tall", "Knee tracks over toes", "Control descent"], avoid: ["Leaning forward", "Knee caving", "Losing balance"] }
    ]},
    fullbody: { name: "Full Body Day", exercises: [
        { name: "Squats", muscles: "Quads, Glutes, Core", goal: "Full body strength", sets: "3 sets", reps: "8-12 reps", currentWeight: 0, weightUnit: "kg", steps: ["Feet shoulder-width", "Lower hips back and down", "Drive through full foot"], focus: ["Chest proud", "Knees track over toes", "Full depth"], avoid: ["Knees caving", "Forward lean", "Arching back"] },
        { name: "Dumbbell Bench Press", muscles: "Chest, Shoulders, Triceps", goal: "Upper body strength", sets: "3 sets", reps: "8-12 reps", currentWeight: 0, weightUnit: "kg", steps: ["Lie on bench", "Press dumbbells up", "Lower with control"], focus: ["Shoulder blades back", "45¬∞ elbows", "Controlled descent"], avoid: ["Flaring elbows", "Bouncing", "Excessive arch"] },
        { name: "Single-Arm Row", muscles: "Back, Lats, Core", goal: "Back strength", sets: "3 sets each", reps: "10-12 reps", currentWeight: 0, weightUnit: "kg", steps: ["One hand on bench", "Pull dumbbell to hip", "Lower with control"], focus: ["Torso stays square", "Pull elbow back", "Squeeze at top"], avoid: ["Rotating torso", "Using momentum", "Shrugging"] },
        { name: "Romanian Deadlift", muscles: "Hamstrings, Glutes", goal: "Posterior chain", sets: "3 sets", reps: "8-12 reps", currentWeight: 0, weightUnit: "kg", steps: ["Stand with barbell", "Push hips back", "Drive hips forward"], focus: ["Hips move back", "Hamstring stretch", "Ribs down"], avoid: ["Rounding back", "Too much knee bend", "Overextending"] },
        { name: "Overhead Press", muscles: "Shoulders, Triceps", goal: "Shoulder strength", sets: "3 sets", reps: "8-12 reps", currentWeight: 0, weightUnit: "kg", steps: ["Barbell at shoulders", "Press overhead", "Lower with control"], focus: ["Ribs stay down", "Core tight", "Press straight up"], avoid: ["Arching back", "Leaning back", "Flaring ribs"] },
        { name: "Plank", muscles: "Core, Shoulders", goal: "Core stability", sets: "3 sets", reps: "30-60 sec", currentWeight: 0, weightUnit: "bodyweight", steps: ["Forearms on ground", "Body in straight line", "Hold position"], focus: ["Squeeze glutes", "Ribs down", "Neutral spine"], avoid: ["Sagging hips", "Piking up", "Holding breath"] }
    ]},
    anterior: { name: "Anterior Day", exercises: [
        { name: "Dumbbell Bench Press", muscles: "Chest, Shoulders", goal: "Chest strength", sets: "3 sets", reps: "8-12 reps", currentWeight: 0, weightUnit: "kg", steps: ["Lie on bench", "Press dumbbells up", "Lower with control"], focus: ["Shoulder blades back", "45¬∞ elbows", "Controlled"], avoid: ["Flaring elbows", "Bouncing", "Excessive arch"] },
        { name: "Incline Press", muscles: "Upper Chest, Shoulders", goal: "Upper chest development", sets: "3 sets", reps: "8-12 reps", currentWeight: 0, weightUnit: "kg", steps: ["Bench at 30-45¬∞", "Press dumbbells up", "Lower to upper chest"], focus: ["Shoulder blades retracted", "Press up and in", "Stable"], avoid: ["Excessive arch", "Elbows flaring", "Momentum"] },
        { name: "Lateral Raises", muscles: "Side Shoulders", goal: "Shoulder development", sets: "3 sets", reps: "12-15 reps", currentWeight: 0, weightUnit: "kg", steps: ["Stand with dumbbells", "Raise arms to sides", "Lower with control"], focus: ["Lead with elbows", "Stop at shoulder height", "Control"], avoid: ["Using momentum", "Raising too high", "Shrugging"] },
        { name: "Bicep Curls", muscles: "Biceps", goal: "Bicep development", sets: "3 sets", reps: "10-12 reps", currentWeight: 0, weightUnit: "kg", steps: ["Sit on incline bench", "Curl dumbbells up", "Lower with control"], focus: ["Keep elbows back", "Full range", "Squeeze at top"], avoid: ["Swinging", "Moving elbows forward", "Partial reps"] },
        { name: "Tricep Dips", muscles: "Triceps, Chest", goal: "Arm development", sets: "3 sets", reps: "10-15 reps", currentWeight: 0, weightUnit: "kg", steps: ["Hands on bench", "Lower body by bending elbows", "Press back up"], focus: ["Shoulders down", "Controlled", "Full extension"], avoid: ["Shrugging", "Going too deep", "Leaning forward"] },
        { name: "Leg Raises", muscles: "Lower Abs", goal: "Core strength", sets: "3 sets", reps: "10-15 reps", currentWeight: 0, weightUnit: "bodyweight", steps: ["Hang from bar", "Tuck pelvis, raise knees", "Lower with control"], focus: ["Tuck pelvis first", "Controlled", "No swinging"], avoid: ["Using momentum", "Swinging legs", "Arching back"] }
    ]}
};

// State
let currentWorkout = null;
let currentExerciseIndex = 0;
let currentImageIndex = 0;
let exerciseImages = {};
let workoutHistory = JSON.parse(localStorage.getItem('workoutHistory')) || [];
let currentWorkoutData = [];
let isEditMode = false;

// Initialize
function init() {
    updateHomeStats();
    updateCurrentDate();
    populateExerciseFilter();
    
    const savedImages = localStorage.getItem('exerciseImages');
    if (savedImages) exerciseImages = JSON.parse(savedImages);
    
    Object.keys(workouts).forEach(workoutKey => {
        workouts[workoutKey].exercises.forEach((exercise, index) => {
            const key = `${workoutKey}-${index}`;
            if (!exerciseImages[key]) exerciseImages[key] = [];
        });
    });
}

function updateCurrentDate() {
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', options);
}

// Navigation
function showPage(page) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    
    if (page === 'home') {
        document.getElementById('homePage').classList.add('active');
        document.querySelector('.nav-item:nth-child(1)').classList.add('active');
        updateHomeStats();
    } else if (page === 'stats') {
        document.getElementById('statsPage').classList.add('active');
        document.querySelector('.nav-item:nth-child(2)').classList.add('active');
        updateDashboard();
    }
}

function startWorkout(type) {
    currentWorkout = workouts[type];
    currentExerciseIndex = 0;
    currentWorkoutData = [];
    
    document.getElementById('workoutName').textContent = currentWorkout.name;
    document.getElementById('homePage').classList.remove('active');
    document.getElementById('exercisePage').classList.add('active');
    
    displayExercise();
}

function exitWorkout() {
    if (confirm('Exit workout? Progress will be lost.')) {
        document.getElementById('exercisePage').classList.remove('active');
        document.getElementById('homePage').classList.add('active');
        currentWorkout = null;
        currentExerciseIndex = 0;
    }
}

function displayExercise() {
    const exercise = currentWorkout.exercises[currentExerciseIndex];
    const total = currentWorkout.exercises.length;
    const workoutKey = Object.keys(workouts).find(key => workouts[key] === currentWorkout);
    const imageKey = `${workoutKey}-${currentExerciseIndex}`;
    currentImageIndex = 0;
    
    const progress = ((currentExerciseIndex + 1) / total) * 100;
    document.getElementById('exerciseProgress').style.width = progress + '%';
    document.getElementById('exerciseProgressText').textContent = `Exercise ${currentExerciseIndex + 1} of ${total}`;
    
    const container = document.getElementById('exerciseContent');
    
    if (currentExerciseIndex >= total) {
        saveWorkout();
        container.innerHTML = `
            <div class="completion-screen">
                <div class="completion-icon">üéâ</div>
                <h2 class="completion-title">Workout Complete!</h2>
                <p class="completion-text">Great job on completing ${currentWorkout.name}</p>
                <button class="completion-btn" onclick="completeWorkout()">Done</button>
            </div>
        `;
        document.getElementById('prevExercise').style.display = 'none';
        document.getElementById('nextExercise').style.display = 'none';
        return;
    }

    const images = exerciseImages[imageKey] || [];
    const hasImages = images.length > 0;
    
    container.innerHTML = `
        <h1 class="exercise-title">${isEditMode ? `<input type="text" class="input-field" value="${exercise.name}" id="editName">` : exercise.name}</h1>
        <p class="exercise-muscles">${isEditMode ? `<input type="text" class="input-field" value="${exercise.muscles}" id="editMuscles" placeholder="Muscles">` : exercise.muscles}</p>
        
        <div class="weight-section">
            <div class="weight-grid">
                <div class="input-group">
                    <label class="input-label">Sets</label>
                    <input type="text" class="input-field" value="${exercise.sets}" ${isEditMode ? 'id="editSets"' : 'readonly'}>
                </div>
                <div class="input-group">
                    <label class="input-label">Reps</label>
                    <input type="text" class="input-field" value="${exercise.reps}" ${isEditMode ? 'id="editReps"' : 'readonly'}>
                </div>
            </div>
            <div class="weight-row-2">
                <div class="input-group">
                    <label class="input-label">Weight</label>
                    <input type="number" class="input-field" value="${exercise.currentWeight || ''}" placeholder="0" onchange="updateWeight(this.value)">
                </div>
                <div class="input-group">
                    <label class="input-label">Unit</label>
                    <div class="unit-selector">
                        <button class="unit-btn ${exercise.weightUnit === 'kg' ? 'active' : ''}" onclick="setUnit('kg')">kg</button>
                        <button class="unit-btn ${exercise.weightUnit === 'lbs' ? 'active' : ''}" onclick="setUnit('lbs')">lb</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="image-gallery-section">
            <div class="gallery-main" onclick="document.getElementById('imageUpload').click()">
                ${hasImages ? `
                    ${images.map((img, i) => `
                        <img src="${img}" class="gallery-image ${i === 0 ? 'active' : ''}" data-index="${i}">
                    `).join('')}
                    <button class="gallery-nav left" onclick="event.stopPropagation(); previousImage()" ${images.length <= 1 ? 'disabled' : ''}>‚Äπ</button>
                    <button class="gallery-nav right" onclick="event.stopPropagation(); nextImage()" ${images.length <= 1 ? 'disabled' : ''}>‚Ä∫</button>
                    ${isEditMode ? `<button class="delete-photo-btn" onclick="event.stopPropagation(); deleteCurrentPhoto()" style="display: flex;">√ó</button>` : ''}
                ` : `
                    <div class="gallery-placeholder">
                        <div class="placeholder-icon">üì∑</div>
                        <div class="upload-btn-text">Tap to add form photos</div>
                    </div>
                `}
            </div>
            ${hasImages ? `
                <div class="gallery-thumbnails">
                    ${images.map((img, i) => `
                        <div class="thumbnail-wrapper">
                            <img src="${img}" class="thumbnail ${i === 0 ? 'active' : ''}" onclick="jumpToImage(${i})">
                            ${isEditMode ? `<button class="delete-photo-btn" onclick="event.stopPropagation(); deletePhoto(${i})">√ó</button>` : ''}
                        </div>
                    `).join('')}
                    <div class="thumbnail-add" onclick="document.getElementById('imageUpload').click()">+</div>
                </div>
            ` : ''}
            <input type="file" id="imageUpload" accept="image/*" multiple onchange="handleImageUpload(event)">
        </div>

        <div class="expandable-section" id="goalSection">
            <button class="expandable-header" onclick="toggleSection('goalSection')">
                <span class="expandable-title">üéØ Goal</span>
                <span class="expand-icon">‚ñº</span>
            </button>
            <div class="expandable-content">
                <div class="expandable-inner">
                    ${isEditMode ? `<textarea class="input-field" id="editGoal" style="min-height: 80px;">${exercise.goal}</textarea>` : `<p>${exercise.goal}</p>`}
                </div>
            </div>
        </div>

        <div class="expandable-section" id="stepsSection">
            <button class="expandable-header" onclick="toggleSection('stepsSection')">
                <span class="expandable-title">üìã How to Perform</span>
                <span class="expand-icon">‚ñº</span>
            </button>
            <div class="expandable-content">
                <div class="expandable-inner">
                    ${isEditMode ? `
                        <div id="stepsEdit">
                            ${exercise.steps.map((step, i) => `
                                <div style="margin-bottom: 12px; display: flex; gap: 8px;">
                                    <input type="text" class="input-field" value="${step}" data-step="${i}">
                                    <button onclick="removeStep(${i})" style="padding: 8px 12px; background: var(--danger); color: white; border: none; border-radius: 8px; cursor: pointer;">√ó</button>
                                </div>
                            `).join('')}
                            <button onclick="addStep()" style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px dashed var(--border); border-radius: 12px; cursor: pointer; color: var(--text); font-weight: 600;">+ Add Step</button>
                        </div>
                    ` : `
                        <ul class="steps-list">
                            ${exercise.steps.map((step, i) => `<li class="step-item"><span class="step-number">${i + 1}</span><span>${step}</span></li>`).join('')}
                        </ul>
                    `}
                </div>
            </div>
        </div>

        <div class="expandable-section" id="tipsSection">
            <button class="expandable-header" onclick="toggleSection('tipsSection')">
                <span class="expandable-title">üí° Key Points</span>
                <span class="expand-icon">‚ñº</span>
            </button>
            <div class="expandable-content">
                <div class="expandable-inner">
                    ${isEditMode ? `
                        <div style="margin-bottom: 16px;">
                            <strong style="display: block; margin-bottom: 8px;">Focus Points:</strong>
                            ${exercise.focus.map((item, i) => `
                                <div style="margin-bottom: 8px; display: flex; gap: 8px;">
                                    <input type="text" class="input-field" value="${item}" data-focus="${i}">
                                    <button onclick="removeFocus(${i})" style="padding: 8px 12px; background: var(--danger); color: white; border: none; border-radius: 8px; cursor: pointer;">√ó</button>
                                </div>
                            `).join('')}
                            <button onclick="addFocus()" style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px dashed var(--border); border-radius: 12px; cursor: pointer; color: var(--text); font-weight: 600; margin-bottom: 16px;">+ Add Focus Point</button>
                        </div>
                        <div>
                            <strong style="display: block; margin-bottom: 8px;">Avoid:</strong>
                            ${exercise.avoid.map((item, i) => `
                                <div style="margin-bottom: 8px; display: flex; gap: 8px;">
                                    <input type="text" class="input-field" value="${item}" data-avoid="${i}">
                                    <button onclick="removeAvoid(${i})" style="padding: 8px 12px; background: var(--danger); color: white; border: none; border-radius: 8px; cursor: pointer;">√ó</button>
                                </div>
                            `).join('')}
                            <button onclick="addAvoid()" style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px dashed var(--border); border-radius: 12px; cursor: pointer; color: var(--text); font-weight: 600;">+ Add Avoid Point</button>
                        </div>
                    ` : `
                        <div class="tips-grid">
                            ${exercise.focus.map(item => `<div class="tip-item tip-focus">‚úì ${item}</div>`).join('')}
                            ${exercise.avoid.map(item => `<div class="tip-item tip-avoid">‚úó ${item}</div>`).join('')}
                        </div>
                    `}
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('prevExercise').disabled = currentExerciseIndex === 0;
    document.getElementById('prevExercise').style.display = 'block';
    document.getElementById('nextExercise').style.display = 'block';
}

function toggleSection(sectionId) {
    document.getElementById(sectionId).classList.toggle('expanded');
}

function updateWeight(value) {
    currentWorkout.exercises[currentExerciseIndex].currentWeight = parseFloat(value) || 0;
}

function setUnit(unit) {
    currentWorkout.exercises[currentExerciseIndex].weightUnit = unit;
    displayExercise();
}

function previousExercise() {
    if (currentExerciseIndex > 0) {
        if (isEditMode) saveEdits();
        isEditMode = false;
        document.getElementById('editBtn').textContent = 'Edit';
        saveCurrentExercise();
        currentExerciseIndex--;
        displayExercise();
    }
}

function nextExercise() {
    if (isEditMode) saveEdits();
    isEditMode = false;
    document.getElementById('editBtn').textContent = 'Edit';
    saveCurrentExercise();
    currentExerciseIndex++;
    displayExercise();
}

function saveCurrentExercise() {
    if (currentWorkout) {
        const exercise = currentWorkout.exercises[currentExerciseIndex];
        currentWorkoutData[currentExerciseIndex] = {
            name: exercise.name,
            weight: exercise.currentWeight || 0,
            unit: exercise.weightUnit || 'kg',
            sets: exercise.sets,
            reps: exercise.reps
        };
    }
}

function completeWorkout() {
    document.getElementById('exercisePage').classList.remove('active');
    document.getElementById('homePage').classList.add('active');
    currentWorkout = null;
    currentExerciseIndex = 0;
    updateHomeStats();
}

function saveWorkout() {
    if (!currentWorkout || currentWorkoutData.length === 0) return;
    
    const workoutKey = Object.keys(workouts).find(key => workouts[key] === currentWorkout);
    workoutHistory.push({
        date: new Date().toISOString(),
        name: currentWorkout.name,
        workoutType: workoutKey,
        exercises: currentWorkoutData.filter(e => e !== undefined)
    });
    
    localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
}

// Image handling
function handleImageUpload(event) {
    const files = event.target.files;
    const workoutKey = Object.keys(workouts).find(key => workouts[key] === currentWorkout);
    const imageKey = `${workoutKey}-${currentExerciseIndex}`;
    
    if (!exerciseImages[imageKey]) exerciseImages[imageKey] = [];
    
    Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
            exerciseImages[imageKey].push(e.target.result);
            localStorage.setItem('exerciseImages', JSON.stringify(exerciseImages));
            displayExercise();
        };
        reader.readAsDataURL(file);
    });
    
    event.target.value = '';
}

function nextImage() {
    const workoutKey = Object.keys(workouts).find(key => workouts[key] === currentWorkout);
    const imageKey = `${workoutKey}-${currentExerciseIndex}`;
    const images = exerciseImages[imageKey] || [];
    
    if (currentImageIndex < images.length - 1) {
        currentImageIndex++;
        updateGalleryDisplay();
    }
}

function previousImage() {
    if (currentImageIndex > 0) {
        currentImageIndex--;
        updateGalleryDisplay();
    }
}

function jumpToImage(index) {
    currentImageIndex = index;
    updateGalleryDisplay();
}

function updateGalleryDisplay() {
    const galleryImages = document.querySelectorAll('.gallery-image');
    const thumbnails = document.querySelectorAll('.thumbnail');
    
    galleryImages.forEach((img, i) => img.classList.toggle('active', i === currentImageIndex));
    thumbnails.forEach((thumb, i) => thumb.classList.toggle('active', i === currentImageIndex));
}

// Edit mode functions
function toggleEdit() {
    isEditMode = !isEditMode;
    const editBtn = document.getElementById('editBtn');
    
    if (isEditMode) {
        editBtn.textContent = 'Save';
        editBtn.style.fontWeight = '700';
        displayExercise();
    } else {
        saveEdits();
        editBtn.textContent = 'Edit';
        editBtn.style.fontWeight = '500';
        displayExercise();
    }
}

function saveEdits() {
    const exercise = currentWorkout.exercises[currentExerciseIndex];
    
    const nameInput = document.getElementById('editName');
    const musclesInput = document.getElementById('editMuscles');
    const setsInput = document.getElementById('editSets');
    const repsInput = document.getElementById('editReps');
    const goalInput = document.getElementById('editGoal');
    
    if (nameInput) exercise.name = nameInput.value;
    if (musclesInput) exercise.muscles = musclesInput.value;
    if (setsInput) exercise.sets = setsInput.value;
    if (repsInput) exercise.reps = repsInput.value;
    if (goalInput) exercise.goal = goalInput.value;
    
    // Save steps
    const stepInputs = document.querySelectorAll('[data-step]');
    if (stepInputs.length > 0) {
        exercise.steps = Array.from(stepInputs).map(input => input.value).filter(v => v);
    }
    
    // Save focus points
    const focusInputs = document.querySelectorAll('[data-focus]');
    if (focusInputs.length > 0) {
        exercise.focus = Array.from(focusInputs).map(input => input.value).filter(v => v);
    }
    
    // Save avoid points
    const avoidInputs = document.querySelectorAll('[data-avoid]');
    if (avoidInputs.length > 0) {
        exercise.avoid = Array.from(avoidInputs).map(input => input.value).filter(v => v);
    }
}

function addStep() {
    const exercise = currentWorkout.exercises[currentExerciseIndex];
    exercise.steps.push('');
    displayExercise();
    // Expand the section
    document.getElementById('stepsSection').classList.add('expanded');
}

function removeStep(index) {
    const exercise = currentWorkout.exercises[currentExerciseIndex];
    exercise.steps.splice(index, 1);
    displayExercise();
    document.getElementById('stepsSection').classList.add('expanded');
}

function addFocus() {
    const exercise = currentWorkout.exercises[currentExerciseIndex];
    exercise.focus.push('');
    displayExercise();
    document.getElementById('tipsSection').classList.add('expanded');
}

function removeFocus(index) {
    const exercise = currentWorkout.exercises[currentExerciseIndex];
    exercise.focus.splice(index, 1);
    displayExercise();
    document.getElementById('tipsSection').classList.add('expanded');
}

function addAvoid() {
    const exercise = currentWorkout.exercises[currentExerciseIndex];
    exercise.avoid.push('');
    displayExercise();
    document.getElementById('tipsSection').classList.add('expanded');
}

function removeAvoid(index) {
    const exercise = currentWorkout.exercises[currentExerciseIndex];
    exercise.avoid.splice(index, 1);
    displayExercise();
    document.getElementById('tipsSection').classList.add('expanded');
}

function deleteCurrentPhoto() {
    const workoutKey = Object.keys(workouts).find(key => workouts[key] === currentWorkout);
    const imageKey = `${workoutKey}-${currentExerciseIndex}`;
    const images = exerciseImages[imageKey] || [];
    
    if (images.length > 0 && confirm('Delete this photo?')) {
        const wasEditMode = isEditMode; // Preserve edit mode
        exerciseImages[imageKey].splice(currentImageIndex, 1);
        currentImageIndex = Math.max(0, currentImageIndex - 1);
        localStorage.setItem('exerciseImages', JSON.stringify(exerciseImages));
        isEditMode = wasEditMode;
        displayExercise();
        // Update button text
        if (isEditMode) {
            document.getElementById('editBtn').textContent = 'Save';
            document.getElementById('editBtn').style.fontWeight = '700';
        }
    }
}

function deletePhoto(index) {
    const workoutKey = Object.keys(workouts).find(key => workouts[key] === currentWorkout);
    const imageKey = `${workoutKey}-${currentExerciseIndex}`;
    
    if (confirm('Delete this photo?')) {
        const wasEditMode = isEditMode; // Preserve edit mode
        exerciseImages[imageKey].splice(index, 1);
        if (currentImageIndex >= exerciseImages[imageKey].length) {
            currentImageIndex = Math.max(0, exerciseImages[imageKey].length - 1);
        }
        localStorage.setItem('exerciseImages', JSON.stringify(exerciseImages));
        isEditMode = wasEditMode;
        displayExercise();
        // Update button text
        if (isEditMode) {
            document.getElementById('editBtn').textContent = 'Save';
            document.getElementById('editBtn').style.fontWeight = '700';
        }
    }
}

// Stats
function updateHomeStats() {
    const now = new Date();
    const oneWeekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
    const oneMonthAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
    
    document.getElementById('homeTotal').textContent = workoutHistory.length;
    
    const thisMonth = workoutHistory.filter(w => new Date(w.date) >= oneMonthAgo).length;
    document.getElementById('homeTotalChange').textContent = `+${thisMonth} this month`;
    
    const thisWeek = workoutHistory.filter(w => new Date(w.date) >= oneWeekAgo).length;
    document.getElementById('homeWeekly').textContent = thisWeek;
    
    let streak = 0;
    const sortedDates = workoutHistory.map(w => new Date(w.date).toDateString()).reverse();
    const uniqueDates = [...new Set(sortedDates)];
    
    for (let i = 0; i < uniqueDates.length; i++) {
        const date = new Date(uniqueDates[i]);
        const expectedDate = new Date(now - i * 24 * 60 * 60 * 1000).toDateString();
        if (date.toDateString() === expectedDate) streak++;
        else break;
    }
    
    document.getElementById('homeStreak').textContent = streak;
}

function populateExerciseFilter() {
    const filter = document.getElementById('exerciseFilter');
    const exercises = new Set();
    
    Object.values(workouts).forEach(workout => {
        workout.exercises.forEach(ex => exercises.add(ex.name));
    });
    
    filter.innerHTML = '<option value="">All Exercises</option>' +
        Array.from(exercises).sort().map(name => `<option value="${name}">${name}</option>`).join('');
}

function updateDashboard() {
    const selectedExercise = document.getElementById('exerciseFilter').value;
    const timeframe = document.getElementById('timeframeFilter').value;
    
    const now = new Date();
    const filteredHistory = workoutHistory.filter(w => {
        const workoutDate = new Date(w.date);
        const daysDiff = (now - workoutDate) / (1000 * 60 * 60 * 24);
        return timeframe === 'all' || daysDiff <= parseInt(timeframe);
    });
    
    updateProgressChart(filteredHistory, selectedExercise);
    updatePersonalRecords(filteredHistory);
}

function updateProgressChart(history, selectedExercise) {
    const ctx = document.getElementById('progressChart');
    if (!ctx) return;
    
    try {
        const exerciseData = [];
        history.forEach(workout => {
            workout.exercises.forEach(ex => {
                if (!selectedExercise || ex.name === selectedExercise) {
                    exerciseData.push({ date: new Date(workout.date), exercise: ex.name, weight: ex.weight });
                }
            });
        });
        
        const groupedData = {};
        exerciseData.forEach(item => {
            if (!groupedData[item.exercise]) groupedData[item.exercise] = [];
            groupedData[item.exercise].push(item);
        });
        
        const colors = ['#007AFF', '#34C759', '#FF9500', '#FF3B30', '#AF52DE', '#5AC8FA'];
        const datasets = Object.entries(groupedData).map(([exercise, data], index) => ({
            label: exercise,
            data: data.map(d => ({ x: d.date, y: d.weight })),
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length],
            tension: 0.4,
            borderWidth: 2,
            pointRadius: 4
        }));
        
        if (window.progressChart && typeof window.progressChart.destroy === 'function') {
            window.progressChart.destroy();
        }
        
        if (datasets.length === 0) {
            ctx.parentElement.innerHTML = '<div class="empty-state"><div class="empty-icon">üìà</div><div>Complete workouts to see progress</div></div>';
            return;
        }
        
        window.progressChart = new Chart(ctx, {
            type: 'line',
            data: { datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: datasets.length > 1,
                        labels: { color: '#000', font: { size: 13, weight: '600' }, usePointStyle: true }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'day', displayFormats: { day: 'MMM d' } },
                        grid: { display: false },
                        ticks: { color: '#6C6C70' }
                    },
                    y: {
                        beginAtZero: true,
                        grid: { color: '#E5E5EA' },
                        ticks: { color: '#6C6C70' }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Chart error:', error);
    }
}

function updatePersonalRecords(history) {
    const prs = {};
    
    history.forEach(workout => {
        workout.exercises.forEach(ex => {
            if (!prs[ex.name] || ex.weight > prs[ex.name].weight) {
                prs[ex.name] = { weight: ex.weight, unit: ex.unit, date: workout.date };
            }
        });
    });
    
    const container = document.getElementById('recordsList');
    
    if (Object.keys(prs).length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üèÜ</div><div>Complete workouts to see PRs</div></div>';
        return;
    }
    
    container.innerHTML = Object.entries(prs)
        .sort((a, b) => b[1].weight - a[1].weight)
        .slice(0, 5)
        .map(([exercise, pr]) => `
            <div class="record-item">
                <div class="record-info">
                    <h4>${exercise}</h4>
                    <div class="record-date">${new Date(pr.date).toLocaleDateString()}</div>
                </div>
                <div class="record-value">${pr.weight} ${pr.unit}</div>
            </div>
        `).join('');
}

// Initialize
init();
</script>
</body>
</html>
